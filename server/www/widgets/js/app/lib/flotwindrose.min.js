define(function(require){"use strict";var $=require("jquery"),_=require("underscore"),Backbone=require("backbone");require("flot");require("flot_resize");require("flot_windrose");return Backbone.View.extend({settings:{points:150,instant:true,showtips:true,get:function(key){return this[key]}},initialize:function(options){if(options&&options.settings){for(var prop in options.settings){this.settings[prop]=options.settings[prop]}}this.livedata=[];this.previousPoint=null;this.plotOptions={series:{rose:{active:true,roseSize:.8,leafSize:.5,drawGrid:{gridMode:"ticks",labelPos:.5,drawValue:true}}},grid:{hoverable:true,clickable:true,tickLabel:["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"]}}},render:function(){console.log("Rendering a flow wind rose widget");$(this.el).html('<div class="chart" style="position: relative; min-height: 350px;"></div>');this.addPlot();return this},addPlot:function(){var d1=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];var data=[{label:"8+",color:"red",data:d1,rose:{show:true}},{label:"4-7",color:{colors:["yellow","orange","red"]},data:d1,rose:{show:true}},{label:"1-3",color:"green",data:d1,rose:{show:true}}];this.plot=$.plot($(".chart",this.el),data,this.plotOptions)},trimLiveData:function(){if(this.livedata.length>=this.settings.points){this.livedata=this.livedata.slice(1)}},fastAppendPoint:function(data){if(this.settings.points)this.trimLiveData();var stamp=data.timestamp?new Date(data.timestamp).getTime():(new Date).getTime();this.livedata.push({stamp:stamp,dir:data.value.dir,speed:data.value.speed})},redraw:function(){if(this.livedata.length<2)return;var force13=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];var force47=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];var force8p=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],latest=0;for(var i=1;i<this.livedata.length;i++){var data=this.livedata[i-1];var duration=this.livedata[i].stamp-data.stamp;var dir=data.dir/22.5;if(data.speed<10){force13[dir]+=duration}else if(data.speed<33){force47[dir]+=duration}else{force8p[dir]+=duration}}var timespan=this.livedata[this.livedata.length-1].stamp-this.livedata[0].stamp;for(var i=0;i<16;i++){force13[i]=force13[i]/timespan*100;force47[i]=force47[i]/timespan*100;force8p[i]=force8p[i]/timespan*100;force47[i]+=force13[i];force8p[i]+=force47[i]}if(this.settings.instant){latest=this.livedata[this.livedata.length-1].dir}var data=[{label:"8+",color:"red",data:force8p,rose:{show:true}},{label:"4-7",color:{colors:["yellow","orange","red"]},data:force47,rose:{show:true}},{label:"1-3",color:"green",data:force13,rose:{show:true}},{color:"blue",data:[latest],rose:{show:this.settings.instant,pointer:true}}];this.plot.setData(data);this.plot.setupGrid();this.plot.draw()},appendPoint:function(data){this.fastAppendPoint(data);this.redraw()}})});